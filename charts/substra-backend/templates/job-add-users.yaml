{{- range $index, $value := .Values.users }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "substra.fullname" $ }}-add-users-{{ $index }}
  labels:
    app.kubernetes.io/managed-by: {{ $.Release.Service }}
    app.kubernetes.io/instance: {{ $.Release.Name }}
    helm.sh/chart: {{ $.Chart.Name }}-{{ $.Chart.Version }}
    app.kubernetes.io/name: {{ template "substra.name" $ }}-add-users-{{ $index }}
    app.kubernetes.io/part-of: {{ template "substra.name" $ }}
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: add-users
        image: "{{ $.Values.backend.image.repository }}:{{ $.Values.backend.image.tag }}"
        imagePullPolicy: "{{ $.Values.backend.image.pullPolicy }}"
        command: ["/bin/bash"]
        args: ["-c", "./manage.py add_user '{{ .name }}' '{{ .secret }}'"]
        env:
          - name: DJANGO_SETTINGS_MODULE
            value: backend.settings.{{ $.Values.backend.settings }}
          - name: BACKEND_DB_NAME
            value: {{ $.Values.postgresql.postgresqlDatabase }}
          - name: BACKEND_DB_USER
            value: {{ $.Values.postgresql.postgresqlUsername }}
          - name: BACKEND_DB_PWD
            value: {{ $.Values.postgresql.postgresqlPassword }}
          - name: DATABASE_HOST
            value: {{ $.Release.Name }}-postgresql
          - name: PYTHONUNBUFFERED
            value: "1"
{{- end }}
